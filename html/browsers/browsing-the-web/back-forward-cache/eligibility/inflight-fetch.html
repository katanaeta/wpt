<!doctype html>
<script src="/resources/testharness.js"></script>
<script src="/resources/testharnessreport.js"></script>
<script src="/common/utils.js"></script>
<script src="/common/dispatcher/dispatcher.js"></script>
<script src="../resources/helper.sub.js"></script>
<script>
// Check whether the page is BFCached when there are in-flight network requests
// at the time of navigation.
promise_test(async t => {
  const pageA = new RemoteContext(token());
  const pageB = new RemoteContext(token());

  const urlA = location.origin + executorPath + pageA.context_id;
  const urlB = originCrossSite + executorPath + pageB.context_id;

  window.open(urlA, '_blank', 'noopener');

  // Initiate a slow `fetch()` and then navigate to `urlB`.
  await pageA.execute_script(waitForPageShow);
  await pageA.execute_script(
    (url) => {
      window.fetchPromise = fetch('/common/slow.py');
      prepareNavigation(() => { location.href = url; });
    },
    [urlB]);

  // Back navigate to `urlA`.
  await pageB.execute_script(waitForPageShow);
  await pageB.execute_script(
    () => {
      prepareNavigation(() => { history.back(); });
    }
  );
  await pageA.execute_script(waitForPageShow);
  await assert_bfcached(pageA);

  // Wait for fetch() completion.
  assert_equals(
    await pageA.execute_script(() => window.fetchPromise.then(r => r.text())),
    '',
    'Fetch should complete after restored from BFCache');
}, 'Eligibility (in-flight fetch)');
</script>
